import os
import psycopg2
from psycopg2.extras import RealDictCursor
import requests
import telebot
from telebot import types
import logging
from datetime import datetime
import json

logging.basicConfig(level=logging.INFO)

bot = telebot.TeleBot('7567419832:AAGv0eE9K7bAuOMMzv_F8SskyAb4Qcj-tG0')
ADMIN_GROUP_ID = "-4940285744"
ADMIN_IDS = [824360574]

# –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ç–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–Ω–æ)
user_states = {}
admin_states = {}

class UserState:
    LANGUAGE = "language"
    AGE = "age"
    GENDER = "gender"
    BIRTHPLACE = "birthplace"
    FAMILY = "family"
    COURSE = "course"
    SPECIALTY = "specialty"
    HOUSING = "housing"
    COMPLETED = "completed"

class AdminState:
    IDLE = "idle"
    SELECTING_USER = "selecting_user"
    WRITING_MESSAGE = "writing_message"
    SEARCHING = "searching"

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
def get_db_connection():
    try:
        conn = psycopg2.connect(
            host=os.environ.get('PGHOST'),
            port=os.environ.get('PGPORT', 5432),
            database=os.environ.get('PGDATABASE'),
            user=os.environ.get('PGUSER'),
            password=os.environ.get('PGPASSWORD')
        )
        return conn
    except Exception as e:
        logging.error(f"Database connection error: {e}")
        return None

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
def init_database():
    conn = get_db_connection()
    if conn:
        cursor = conn.cursor()
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS students (
                id SERIAL PRIMARY KEY,
                telegram_id BIGINT UNIQUE NOT NULL,
                telegram_username VARCHAR(255),
                telegram_first_name VARCHAR(255),
                telegram_last_name VARCHAR(255),
                user_language VARCHAR(10),
                user_age INTEGER,
                user_gender VARCHAR(20),
                user_birthplace VARCHAR(100),
                user_family_status VARCHAR(50),
                user_course INTEGER,
                user_specialty TEXT,
                user_housing_type VARCHAR(50),
                registration_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                profile_completed BOOLEAN DEFAULT FALSE,
                last_activity TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS conversations (
                id SERIAL PRIMARY KEY,
                telegram_id BIGINT REFERENCES students(telegram_id),
                question TEXT,
                answer TEXT,
                category VARCHAR(50),
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS admin_messages (
                id SERIAL PRIMARY KEY,
                admin_id BIGINT,
                target_user_id BIGINT REFERENCES students(telegram_id),
                message_text TEXT,
                sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                delivered BOOLEAN DEFAULT FALSE
            )
        ''')
        
        conn.commit()
        cursor.close()
        conn.close()
        logging.info("Database initialized successfully")

# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
def save_student_profile(profile_data):
    conn = get_db_connection()
    if conn:
        cursor = conn.cursor()
        cursor.execute('''
            INSERT INTO students (
                telegram_id, telegram_username, telegram_first_name, 
                telegram_last_name, user_language, user_age, user_gender,
                user_birthplace, user_family_status, user_course, 
                user_specialty, user_housing_type, profile_completed
            ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
            ON CONFLICT (telegram_id) 
            DO UPDATE SET
                telegram_username = EXCLUDED.telegram_username,
                telegram_first_name = EXCLUDED.telegram_first_name,
                telegram_last_name = EXCLUDED.telegram_last_name,
                user_language = EXCLUDED.user_language,
                user_age = EXCLUDED.user_age,
                user_gender = EXCLUDED.user_gender,
                user_birthplace = EXCLUDED.user_birthplace,
                user_family_status = EXCLUDED.user_family_status,
                user_course = EXCLUDED.user_course,
                user_specialty = EXCLUDED.user_specialty,
                user_housing_type = EXCLUDED.user_housing_type,
                profile_completed = EXCLUDED.profile_completed,
                last_activity = CURRENT_TIMESTAMP
        ''', (
            profile_data['telegram_id'], profile_data.get('telegram_username'),
            profile_data.get('telegram_first_name'), profile_data.get('telegram_last_name'),
            profile_data.get('user_language'), profile_data.get('user_age'),
            profile_data.get('user_gender'), profile_data.get('user_birthplace'),
            profile_data.get('user_family_status'), profile_data.get('user_course'),
            profile_data.get('user_specialty'), profile_data.get('user_housing_type'),
            True
        ))
        conn.commit()
        cursor.close()
        conn.close()

def save_conversation(telegram_id, question, answer, category=None):
    conn = get_db_connection()
    if conn:
        cursor = conn.cursor()
        cursor.execute('''
            INSERT INTO conversations (telegram_id, question, answer, category)
            VALUES (%s, %s, %s, %s)
        ''', (telegram_id, question, answer, category))
        conn.commit()
        cursor.close()
        conn.close()

def get_student_by_id(telegram_id):
    conn = get_db_connection()
    if conn:
        cursor = conn.cursor(cursor_factory=RealDictCursor)
        cursor.execute('SELECT * FROM students WHERE telegram_id = %s', (telegram_id,))
        result = cursor.fetchone()
        cursor.close()
        conn.close()
        return dict(result) if result else None
    return None

def get_all_students(limit=None, search_term=None):
    conn = get_db_connection()
    if conn:
        cursor = conn.cursor(cursor_factory=RealDictCursor)
        query = 'SELECT * FROM students WHERE profile_completed = TRUE'
        params = []
        
        if search_term:
            query += ''' AND (
                LOWER(telegram_first_name) LIKE LOWER(%s) OR 
                LOWER(telegram_last_name) LIKE LOWER(%s) OR 
                LOWER(telegram_username) LIKE LOWER(%s) OR 
                LOWER(user_specialty) LIKE LOWER(%s)
            )'''
            search_pattern = f"%{search_term}%"
            params.extend([search_pattern, search_pattern, search_pattern, search_pattern])
        
        query += ' ORDER BY registration_date DESC'
        
        if limit:
            query += f' LIMIT {limit}'
            
        cursor.execute(query, params)
        results = cursor.fetchall()
        cursor.close()
        conn.close()
        return [dict(row) for row in results]
    return []

def get_student_conversations(telegram_id, limit=10):
    conn = get_db_connection()
    if conn:
        cursor = conn.cursor(cursor_factory=RealDictCursor)
        cursor.execute('''
            SELECT * FROM conversations 
            WHERE telegram_id = %s 
            ORDER BY created_at DESC 
            LIMIT %s
        ''', (telegram_id, limit))
        results = cursor.fetchall()
        cursor.close()
        conn.close()
        return [dict(row) for row in results]
    return []

def save_admin_message(admin_id, target_user_id, message_text):
    conn = get_db_connection()
    if conn:
        cursor = conn.cursor()
        cursor.execute('''
            INSERT INTO admin_messages (admin_id, target_user_id, message_text)
            VALUES (%s, %s, %s)
        ''', (admin_id, target_user_id, message_text))
        conn.commit()
        cursor.close()
        conn.close()

# –§—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è –º–µ–Ω—é (–æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
def create_language_menu():
    markup = types.InlineKeyboardMarkup(row_width=1)
    markup.add(types.InlineKeyboardButton("üá∞üáø “ö–∞–∑–∞“õ—à–∞", callback_data="lang_kz"))
    markup.add(types.InlineKeyboardButton("üá∑üá∫ –†—É—Å—Å–∫–∏–π", callback_data="lang_ru"))
    markup.add(types.InlineKeyboardButton("üá∫üá∏ English", callback_data="lang_en"))
    return markup

def create_gender_menu(language):
    markup = types.InlineKeyboardMarkup(row_width=2)
    
    if language == "kz":
        markup.add(
            types.InlineKeyboardButton("üë® –ï—Ä", callback_data="gender_male"),
            types.InlineKeyboardButton("üë© ”ò–π–µ–ª", callback_data="gender_female")
        )
    elif language == "en":
        markup.add(
            types.InlineKeyboardButton("üë® Male", callback_data="gender_male"),
            types.InlineKeyboardButton("üë© Female", callback_data="gender_female")
        )
    else:
        markup.add(
            types.InlineKeyboardButton("üë® –ú—É–∂—Å–∫–æ–π", callback_data="gender_male"),
            types.InlineKeyboardButton("üë© –ñ–µ–Ω—Å–∫–∏–π", callback_data="gender_female")
        )
    return markup

def create_birthplace_menu(language):
    markup = types.InlineKeyboardMarkup(row_width=1)
    
    regions = [
        ("üèõÔ∏è –ì–æ—Ä–æ–¥ –ê—Å—Ç–∞–Ω–∞", "astana"),
        ("üåÜ –ì–æ—Ä–æ–¥ –ê–ª–º–∞-–ê—Ç–∞", "almaty"),
        ("üèôÔ∏è –ì–æ—Ä–æ–¥ –®—ã–º–∫–µ–Ω—Ç", "shymkent"),
        ("üåæ –ê–±–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "abai"),
        ("üå± –ê–∫–º–æ–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "akmola"),
        ("‚ö° –ê–∫—Ç—é–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "aktobe"),
        ("üçé –ê–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "almaty_region"),
        ("üõ¢Ô∏è –ê—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "atyrau"),
        ("üèîÔ∏è –í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "east_kz"),
        ("üåø –ñ–∞–º–±—ã–ª—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "zhambyl"),
        ("üçá –ñ–µ—Ç—ã—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "jetysu"),
        ("üåæ –ó–∞–ø–∞–¥–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "west_kz"),
        ("‚öíÔ∏è –ö–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "karaganda"),
        ("üåæ –ö–æ—Å—Ç–∞–Ω–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "kostanay"),
        ("üèúÔ∏è –ö—ã–∑—ã–ª–æ—Ä–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "kyzylorda"),
        ("üåä –ú–∞–Ω–≥–∏—Å—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "mangistau"),
        ("üè≠ –ü–∞–≤–ª–æ–¥–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "pavlodar"),
        ("‚ùÑÔ∏è –°–µ–≤–µ—Ä–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "north_kz"),
        ("üïå –¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "turkestan"),
        ("‚õ∞Ô∏è –£–ª—ã—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "ulytau")
    ]
    
    for text, callback_data in regions:
        markup.add(types.InlineKeyboardButton(text, callback_data=f"birthplace_{callback_data}"))
    
    return markup

def create_family_menu(language):
    markup = types.InlineKeyboardMarkup(row_width=1)
    
    if language == "kz":
        markup.add(types.InlineKeyboardButton("üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –¢–æ–ª—ã“õ –æ—Ç–±–∞—Å—ã", callback_data="family_full"))
        markup.add(types.InlineKeyboardButton("üíî –¢–æ–ª—ã“õ –µ–º–µ—Å –æ—Ç–±–∞—Å—ã", callback_data="family_incomplete"))
        markup.add(types.InlineKeyboardButton("üòî –ñ–µ—Ç—ñ–º", callback_data="family_orphan"))
    elif language == "en":
        markup.add(types.InlineKeyboardButton("üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Complete family", callback_data="family_full"))
        markup.add(types.InlineKeyboardButton("üíî Incomplete family", callback_data="family_incomplete"))
        markup.add(types.InlineKeyboardButton("üòî Orphan", callback_data="family_orphan"))
    else:
        markup.add(types.InlineKeyboardButton("üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –ü–æ–ª–Ω–∞—è", callback_data="family_full"))
        markup.add(types.InlineKeyboardButton("üíî –ù–µ–ø–æ–ª–Ω–∞—è", callback_data="family_incomplete"))
        markup.add(types.InlineKeyboardButton("üòî –°–∏—Ä–æ—Ç–∞", callback_data="family_orphan"))
    return markup

def create_course_menu(language):
    markup = types.InlineKeyboardMarkup(row_width=4)
    markup.add(
        types.InlineKeyboardButton("1Ô∏è‚É£ 1 –∫—É—Ä—Å", callback_data="course_1"),
        types.InlineKeyboardButton("2Ô∏è‚É£ 2 –∫—É—Ä—Å", callback_data="course_2"),
        types.InlineKeyboardButton("3Ô∏è‚É£ 3 –∫—É—Ä—Å", callback_data="course_3"),
        types.InlineKeyboardButton("4Ô∏è‚É£ 4 –∫—É—Ä—Å", callback_data="course_4")
    )
    return markup

def create_housing_menu(language):
    markup = types.InlineKeyboardMarkup(row_width=1)
    
    if language == "kz":
        markup.add(types.InlineKeyboardButton("üè† –ñ–∞—Ç–∞“õ—Ö–∞–Ω–∞", callback_data="housing_dormitory"))
        markup.add(types.InlineKeyboardButton("üè° –ñ–∞–ª–¥–∞—É", callback_data="housing_rent"))
        markup.add(types.InlineKeyboardButton("üèòÔ∏è –ú–µ–Ω—à—ñ–∫—Ç—ñ “Ø–π (—Ç—É—ã—Å—Ç–∞—Ä–¥–∞)", callback_data="housing_own"))
    elif language == "en":
        markup.add(types.InlineKeyboardButton("üè† Dormitory", callback_data="housing_dormitory"))
        markup.add(types.InlineKeyboardButton("üè° Rental", callback_data="housing_rent"))
        markup.add(types.InlineKeyboardButton("üèòÔ∏è Own housing (relatives)", callback_data="housing_own"))
    else:
        markup.add(types.InlineKeyboardButton("üè† –û–±—â–µ–∂–∏—Ç–∏–µ", callback_data="housing_dormitory"))
        markup.add(types.InlineKeyboardButton("üè° –ê—Ä–µ–Ω–¥–∞ –∂–∏–ª—å—è", callback_data="housing_rent"))
        markup.add(types.InlineKeyboardButton("üèòÔ∏è –°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –∂–∏–ª—å–µ (—É —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤)", callback_data="housing_own"))
    return markup

def create_category_menu(language):
    markup = types.InlineKeyboardMarkup(row_width=1)
    
    categories = {
        'kz': [
            ("üí∞ “ö–∞—Ä–∂—ã–ª—ã“õ –º”ô—Å–µ–ª–µ–ª–µ—Ä", "finance"),
            ("üìö –û“õ—É “õ–∏—ã–Ω–¥—ã“õ—Ç–∞—Ä—ã", "study"),
            ("üò∞ ”ò–ª–µ—É–º–µ—Ç—Ç—ñ–∫ “õ–æ—Ä“õ—ã–Ω—ã—à—Ç–∞—Ä", "social"),
            ("üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –û—Ç–±–∞—Å—ã –∂”ô–Ω–µ –æ—Ä—Ç–∞", "family"),
            ("üè† –¢“±—Ä–º—ã—Å—Ç—ã“õ –º”ô—Å–µ–ª–µ–ª–µ—Ä", "household"),
            ("üéØ –ú–∞–º–∞–Ω–¥—ã“õ —Ç–∞“£–¥–∞—É", "career")
        ],
        'ru': [
            ("üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã", "finance"),
            ("üìö –£—á–µ–±–Ω—ã–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏", "study"),
            ("üò∞ –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞—Ö–∏", "social"),
            ("üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –°–µ–º—å—è –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ", "family"),
            ("üè† –ë—ã—Ç–æ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã", "household"),
            ("üéØ –ü—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è", "career")
        ],
        'en': [
            ("üí∞ Financial problems", "finance"),
            ("üìö Academic difficulties", "study"),
            ("üò∞ Social fears", "social"),
            ("üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family and environment", "family"),
            ("üè† Household problems", "household"),
            ("üéØ Career guidance", "career")
        ]
    }
    
    for text, callback_data in categories[language]:
        markup.add(types.InlineKeyboardButton(text, callback_data=f"{callback_data}_{language}"))
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –º–µ–Ω—é
    markup.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é", callback_data="back_to_menu"))
    
    return markup

def get_text(language, key):
    texts = {
        'language_select': {
            'kz': 'üåê –¢—ñ–ª–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑:',
            'ru': 'üåê –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:',
            'en': 'üåê Choose language:'
        },
        'age_request': {
            'kz': 'üéÇ –ñ–∞—Å—ã“£—ã–∑–¥—ã –∂–∞–∑—ã“£—ã–∑ (—Ç–µ–∫ —Ü–∏—Ñ—Ä–ª–∞—Ä):',
            'ru': 'üéÇ –í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–∑—Ä–∞—Å—Ç (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã):',
            'en': 'üéÇ Enter your age (numbers only):'
        },
        'gender_request': {
            'kz': '‚ößÔ∏è –ñ—ã–Ω—ã—Å—ã“£—ã–∑–¥—ã —Ç–∞“£–¥–∞“£—ã–∑:',
            'ru': '‚ößÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø–æ–ª:',
            'en': '‚ößÔ∏è Choose your gender:'
        },
        'birthplace_request': {
            'kz': 'üèôÔ∏è –¢—É“ì–∞–Ω –∂–µ—Ä—ñ“£—ñ–∑–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑:',
            'ru': 'üèôÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è:',
            'en': 'üèôÔ∏è Choose your birthplace:'
        },
        'family_request': {
            'kz': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –û—Ç–±–∞—Å—ã–ª—ã“õ –∂–∞“ì–¥–∞–π—ã“£—ã–∑–¥—ã —Ç–∞“£–¥–∞“£—ã–∑:',
            'ru': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ:',
            'en': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Choose your family status:'
        },
        'course_request': {
            'kz': 'üìö –ö—É—Ä—Å—ã“£—ã–∑–¥—ã —Ç–∞“£–¥–∞“£—ã–∑:',
            'ru': 'üìö –í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å –æ–±—É—á–µ–Ω–∏—è:',
            'en': 'üìö Choose your year of study:'
        },
        'specialty_request': {
            'kz': 'üéì –ú–∞–º–∞–Ω–¥—ã“ì—ã“£—ã–∑–¥—ã –∂–∞–∑—ã“£—ã–∑:',
            'ru': 'üéì –í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:',
            'en': 'üéì Enter your specialty:'
        },
        'housing_request': {
            'kz': 'üè† –¢“±—Ä“ì—ã–ª—ã“õ—Ç—ã –∂–µ—Ä—ñ“£—ñ–∑–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑:',
            'ru': 'üè† –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∂–∏–ª—å—è:',
            'en': 'üè† Choose your housing type:'
        },
        'profile_complete': {
            'kz': '‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Ç–æ–ª—Ç—ã—Ä—ã–ª–¥—ã! –ö–∞—Ç–µ–≥–æ—Ä–∏—è–Ω—ã —Ç–∞“£–¥–∞“£—ã–∑:',
            'ru': '‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –∑–∞–ø–æ–ª–Ω–µ–Ω! –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:',
            'en': '‚úÖ Profile completed! Choose category:'
        },
        'age_invalid': {
            'kz': '‚ùå –ñ–∞—Å—ã“£—ã–∑–¥—ã –¥“±—Ä—ã—Å –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑ (16-35 –∞—Ä–∞—Å—ã–Ω–¥–∞):',
            'ru': '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç (16-35):',
            'en': '‚ùå Please enter a valid age (16-35):'
        }
    }
    
    return texts.get(key, {}).get(language, texts.get(key, {}).get('en', ''))

# –ê–î–ú–ò–ù–°–ö–ò–ï –ö–û–ú–ê–ù–î–´
@bot.message_handler(commands=['admin'])
def admin_command(message):
    if message.from_user.id not in ADMIN_IDS:
        bot.reply_to(message, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω—Å–∫–æ–π –ø–∞–Ω–µ–ª–∏")
        return
    
    admin_states[message.from_user.id] = AdminState.IDLE
    
    markup = types.InlineKeyboardMarkup(row_width=2)
    markup.add(
        types.InlineKeyboardButton("üë• –°–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤", callback_data="admin_list_students"),
        types.InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="admin_stats")
    )
    markup.add(
        types.InlineKeyboardButton("üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ", callback_data="admin_send_message"),
        types.InlineKeyboardButton("üîç –ü–æ–∏—Å–∫ —Å—Ç—É–¥–µ–Ω—Ç–∞", callback_data="admin_search")
    )
    markup.add(types.InlineKeyboardButton("üìã –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–æ–≤", callback_data="admin_conversations"))
    
    bot.reply_to(message, "üõ†Ô∏è –ê–¥–º–∏–Ω—Å–∫–∞—è –ø–∞–Ω–µ–ª—å:", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data.startswith('admin_'))
def handle_admin_commands(call):
    if call.from_user.id not in ADMIN_IDS:
        bot.answer_callback_query(call.id, "‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞")
        return
    
    bot.answer_callback_query(call.id)
    
    if call.data == "admin_list_students":
        show_students_list(call.message)
    elif call.data == "admin_stats":
        show_statistics(call.message)
    elif call.data == "admin_send_message":
        start_message_sending(call.message)
    elif call.data == "admin_search":
        start_student_search(call.message)
    elif call.data == "admin_conversations":
        show_conversations_list(call.message)
    elif call.data == "admin_back":
        admin_command(call.message)

def show_students_list(message, page=1, per_page=5):
    students = get_all_students()
    total_students = len(students)
    start_idx = (page - 1) * per_page
    end_idx = start_idx + per_page
    students_page = students[start_idx:end_idx]
    
    if not students_page:
        bot.edit_message_text("üìù –ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤", 
                             message.chat.id, message.message_id)
        return
    
    text = f"üë• –°–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ (—Å—Ç—Ä. {page} –∏–∑ {(total_students + per_page - 1) // per_page}):\n\n"
    
    for i, student in enumerate(students_page, start_idx + 1):
        name = f"{student.get('telegram_first_name', '')} {student.get('telegram_last_name', '')}".strip()
        username = f"@{student.get('telegram_username')}" if student.get('telegram_username') else "–±–µ–∑ username"
        
        text += f"{i}. {name or '–ë–µ–∑ –∏–º–µ–Ω–∏'}\n"
        text += f"   ID: {student['telegram_id']}\n"
        text += f"   {username}\n"
        text += f"   –ö—É—Ä—Å: {student.get('user_course', '?')}, {student.get('user_specialty', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
        text += f"   –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: {student['registration_date'].strftime('%d.%m.%Y')}\n\n"
    
    markup = types.InlineKeyboardMarkup()
    
    # –ù–∞–≤–∏–≥–∞—Ü–∏—è
    nav_buttons = []
    if page > 1:
        nav_buttons.append(types.InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"students_page_{page-1}"))
    if end_idx < total_students:
        nav_buttons.append(types.InlineKeyboardButton("‚û°Ô∏è –î–∞–ª–µ–µ", callback_data=f"students_page_{page+1}"))
    
    if nav_buttons:
        markup.add(*nav_buttons)
    
    # –î–µ–π—Å—Ç–≤–∏—è
    markup.add(
        types.InlineKeyboardButton("üë§ –ü–æ–¥—Ä–æ–±–Ω–µ–µ", callback_data="admin_student_details"),
        types.InlineKeyboardButton("üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ", callback_data="admin_send_to_student")
    )
    markup.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin_back"))
    
    try:
        bot.edit_message_text(text, message.chat.id, message.message_id, reply_markup=markup)
    except:
        bot.send_message(message.chat.id, text, reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data.startswith('students_page_'))
def handle_students_pagination(call):
    if call.from_user.id not in ADMIN_IDS:
        return
    
    page = int(call.data.split('_')[-1])
    show_students_list(call.message, page)

def show_statistics(message):
    conn = get_db_connection()
    if not conn:
        try:
            bot.edit_message_text("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î", message.chat.id, message.message_id)
        except:
            bot.send_message(message.chat.id, "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î")
        return
    
    cursor = conn.cursor()
    
    # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    cursor.execute("SELECT COUNT(*) FROM students WHERE profile_completed = TRUE")
    total_students = cursor.fetchone()[0]
    
    cursor.execute("SELECT COUNT(*) FROM conversations")
    total_conversations = cursor.fetchone()[0]
    
    # –ü–æ –∫—É—Ä—Å–∞–º
    cursor.execute("SELECT user_course, COUNT(*) FROM students WHERE profile_completed = TRUE GROUP BY user_course ORDER BY user_course")
    courses_stats = cursor.fetchall()
    
    # –ü–æ —Ä–µ–≥–∏–æ–Ω–∞–º (—Ç–æ–ø 5)
    cursor.execute("""
        SELECT user_birthplace, COUNT(*) as count 
        FROM students WHERE profile_completed = TRUE 
        GROUP BY user_birthplace 
        ORDER BY count DESC 
        LIMIT 5
    """)
    regions_stats = cursor.fetchall()
    
    # –ü–æ —Ç–∏–ø—É –∂–∏–ª—å—è
    cursor.execute("SELECT user_housing_type, COUNT(*) FROM students WHERE profile_completed = TRUE GROUP BY user_housing_type")
    housing_stats = cursor.fetchall()
    
    cursor.close()
    conn.close()
    
    text = f"üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–¢–£–î–ï–ù–¢–û–í\n\n"
    text += f"üë• –í—Å–µ–≥–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ: {total_students}\n"
    text += f"üí¨ –í—Å–µ–≥–æ –¥–∏–∞–ª–æ–≥–æ–≤: {total_conversations}\n\n"
    
    if courses_stats:
        text += f"üìö –ü–æ –∫—É—Ä—Å–∞–º:\n"
        for course, count in courses_stats:
            text += f"   {course} –∫—É—Ä—Å: {count} —á–µ–ª.\n"
        text += "\n"
    
    if regions_stats:
        text += f"üèôÔ∏è –¢–æ–ø —Ä–µ–≥–∏–æ–Ω–æ–≤:\n"
        region_names = {
            'astana': '–ê—Å—Ç–∞–Ω–∞', 'almaty': '–ê–ª–º–∞-–ê—Ç–∞', 'shymkent': '–®—ã–º–∫–µ–Ω—Ç',
            'abai': '–ê–±–∞–π—Å–∫–∞—è –æ–±–ª.', 'akmola': '–ê–∫–º–æ–ª–∏–Ω—Å–∫–∞—è –æ–±–ª.'
        }
        for region, count in regions_stats:
            region_name = region_names.get(region, region.replace('_', ' ').title())
            text += f"   {region_name}: {count} —á–µ–ª.\n"
        text += "\n"
    
    if housing_stats:
        text += f"üè† –ü–æ —Ç–∏–ø—É –∂–∏–ª—å—è:\n"
        housing_names = {'dormitory': '–û–±—â–µ–∂–∏—Ç–∏–µ', 'rent': '–ê—Ä–µ–Ω–¥–∞', 'own': '–°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ'}
        for housing, count in housing_stats:
            housing_name = housing_names.get(housing, housing)
            text += f"   {housing_name}: {count} —á–µ–ª.\n"
    
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin_back"))
    
    try:
        bot.edit_message_text(text, message.chat.id, message.message_id, reply_markup=markup)
    except:
        bot.send_message(message.chat.id, text, reply_markup=markup)

def start_message_sending(message):
    admin_states[message.from_user.id] = AdminState.SELECTING_USER
    
    text = "üìß –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç—É\n\n–í–≤–µ–¥–∏—Ç–µ Telegram ID —Å—Ç—É–¥–µ–Ω—Ç–∞:"
    
    try:
        bot.edit_message_text(text, message.chat.id, message.message_id)
    except:
        bot.send_message(message.chat.id, text)

def start_student_search(message):
    admin_states[message.from_user.id] = AdminState.SEARCHING
    
    text = "üîç –ü–æ–∏—Å–∫ —Å—Ç—É–¥–µ–Ω—Ç–∞\n\n–í–≤–µ–¥–∏—Ç–µ –∏–º—è, username –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –ø–æ–∏—Å–∫–∞:"
    
    try:
        bot.edit_message_text(text, message.chat.id, message.message_id)
    except:
        bot.send_message(message.chat.id, text)

def show_conversations_list(message):
    conn = get_db_connection()
    if not conn:
        try:
            bot.edit_message_text("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î", message.chat.id, message.message_id)
        except:
            bot.send_message(message.chat.id, "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î")
        return
    
    cursor = conn.cursor()
    cursor.execute('''
        SELECT c.*, s.telegram_first_name, s.telegram_last_name, s.telegram_username
        FROM conversations c
        JOIN students s ON c.telegram_id = s.telegram_id
        ORDER BY c.created_at DESC
        LIMIT 10
    ''')
    conversations = cursor.fetchall()
    cursor.close()
    conn.close()
    
    if not conversations:
        text = "üí¨ –ù–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤"
    else:
        text = "üí¨ –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –¥–∏–∞–ª–æ–≥–æ–≤:\n\n"
        
    for conv in conversations:
            name = f"{conv[5] or ''} {conv[6] or ''}".strip() or "–ë–µ–∑ –∏–º–µ–Ω–∏"
            username = f"@{conv[7]}" if conv[7] else ""
            
            text += f"üë§ {name} {username}\n"
            text += f"‚ùì {conv[1][:50]}{'...' if len(conv[1]) > 50 else ''}\n"
            text += f"ü§ñ {conv[2][:50]}{'...' if len(conv[2]) > 50 else ''}\n"
            text += f"üìÖ {conv[4].strftime('%d.%m.%Y %H:%M')}\n\n"
    
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin_back"))
    
    try:
        bot.edit_message_text(text, message.chat.id, message.message_id, reply_markup=markup)
    except:
        bot.send_message(message.chat.id, text, reply_markup=markup)

# –û–°–ù–û–í–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ê–ù–ö–ï–¢–ò–†–û–í–ê–ù–ò–Ø
@bot.message_handler(commands=['start'])
def start_command(message):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø—Ä–æ—Ñ–∏–ª—å –≤ –ë–î
    student = get_student_by_id(message.from_user.id)
    
    if student and student.get('profile_completed'):
        # –ü—Ä–æ—Ñ–∏–ª—å —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        language = student.get('user_language', 'ru')
        markup = create_category_menu(language)
        bot.reply_to(message, get_text(language, 'profile_complete'), reply_markup=markup)
    else:
        # –ù–∞—á–∏–Ω–∞–µ–º –∞–Ω–∫–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        user_states[message.from_user.id] = UserState.LANGUAGE
        markup = create_language_menu()
        bot.reply_to(message, get_text('en', 'language_select'), reply_markup=markup)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞
@bot.callback_query_handler(func=lambda call: call.data.startswith('lang_'))
def handle_language_selection(call):
    bot.answer_callback_query(call.id)
    
    language = call.data.split('_')[1]
    user_states[call.from_user.id] = UserState.AGE
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    profile_data = {
        'telegram_id': call.from_user.id,
        'telegram_username': call.from_user.username,
        'telegram_first_name': call.from_user.first_name,
        'telegram_last_name': call.from_user.last_name,
        'user_language': language,
        'profile_completed': False
    }
    save_student_profile(profile_data)
    
    bot.edit_message_text(
        get_text(language, 'age_request'),
        call.message.chat.id,
        call.message.message_id
    )

@bot.callback_query_handler(func=lambda call: call.data.startswith('gender_'))
def handle_gender_selection(call):
    bot.answer_callback_query(call.id)
    
    gender = call.data.split('_')[1]
    student = get_student_by_id(call.from_user.id)
    language = student.get('user_language', 'ru')
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
    profile_data = student.copy()
    profile_data['user_gender'] = gender
    save_student_profile(profile_data)
    
    user_states[call.from_user.id] = UserState.BIRTHPLACE
    
    markup = create_birthplace_menu(language)
    bot.edit_message_text(
        get_text(language, 'birthplace_request'),
        call.message.chat.id,
        call.message.message_id,
        reply_markup=markup
    )

@bot.callback_query_handler(func=lambda call: call.data.startswith('birthplace_'))
def handle_birthplace_selection(call):
    bot.answer_callback_query(call.id)
    
    birthplace = call.data.split('_')[1]
    student = get_student_by_id(call.from_user.id)
    language = student.get('user_language', 'ru')
    
    profile_data = student.copy()
    profile_data['user_birthplace'] = birthplace
    save_student_profile(profile_data)
    
    user_states[call.from_user.id] = UserState.FAMILY
    
    markup = create_family_menu(language)
    bot.edit_message_text(
        get_text(language, 'family_request'),
        call.message.chat.id,
        call.message.message_id,
        reply_markup=markup
    )

@bot.callback_query_handler(func=lambda call: call.data.startswith('family_'))
def handle_family_selection(call):
    bot.answer_callback_query(call.id)
    
    family = call.data.split('_')[1]
    student = get_student_by_id(call.from_user.id)
    language = student.get('user_language', 'ru')
    
    profile_data = student.copy()
    profile_data['user_family_status'] = family
    save_student_profile(profile_data)
    
    user_states[call.from_user.id] = UserState.COURSE
    
    markup = create_course_menu(language)
    bot.edit_message_text(
        get_text(language, 'course_request'),
        call.message.chat.id,
        call.message.message_id,
        reply_markup=markup
    )

@bot.callback_query_handler(func=lambda call: call.data.startswith('course_'))
def handle_course_selection(call):
    bot.answer_callback_query(call.id)
    
    course = call.data.split('_')[1]
    student = get_student_by_id(call.from_user.id)
    language = student.get('user_language', 'ru')
    
    profile_data = student.copy()
    profile_data['user_course'] = int(course)
    save_student_profile(profile_data)
    
    user_states[call.from_user.id] = UserState.SPECIALTY
    
    bot.edit_message_text(
        get_text(language, 'specialty_request'),
        call.message.chat.id,
        call.message.message_id
    )

@bot.callback_query_handler(func=lambda call: call.data.startswith('housing_'))
def handle_housing_selection(call):
    bot.answer_callback_query(call.id)
    
    housing = call.data.split('_')[1]
    student = get_student_by_id(call.from_user.id)
    language = student.get('user_language', 'ru')
    
    profile_data = student.copy()
    profile_data['user_housing_type'] = housing
    profile_data['profile_completed'] = True
    save_student_profile(profile_data)
    
    user_states[call.from_user.id] = UserState.COMPLETED
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω—Å–∫—É—é –≥—Ä—É–ø–ø—É
    send_profile_to_admin(profile_data)
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    markup = create_category_menu(language)
    bot.edit_message_text(
        get_text(language, 'profile_complete'),
        call.message.chat.id,
        call.message.message_id,
        reply_markup=markup
    )

@bot.callback_query_handler(func=lambda call: call.data == 'back_to_menu')
def handle_back_to_menu(call):
    bot.answer_callback_query(call.id)
    
    student = get_student_by_id(call.from_user.id)
    if student and student.get('profile_completed'):
        language = student.get('user_language', 'ru')
        markup = create_category_menu(language)
        bot.edit_message_text(
            get_text(language, 'profile_complete'),
            call.message.chat.id,
            call.message.message_id,
            reply_markup=markup
        )

# –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ê–¢–ï–ì–û–†–ò–ô –ò SHAI.PRO
@bot.callback_query_handler(func=lambda call: any(cat in call.data for cat in ['finance_', 'study_', 'social_', 'family_', 'household_', 'career_']))
def handle_category_selection(call):
    bot.answer_callback_query(call.id)
    
    # –†–∞–∑–±–∏—Ä–∞–µ–º callback_data
    parts = call.data.split('_')
    category = parts[0]
    language = parts[1] if len(parts) > 1 else 'ru'
    
    category_messages = {
        "finance": "–£ –º–µ–Ω—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–µ–Ω—å–≥–∞–º–∏ –∏ —Å—Ç–∏–ø–µ–Ω–¥–∏–µ–π",
        "study": "–£ –º–µ–Ω—è —É—á–µ–±–Ω—ã–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–æ–±–ª–µ–º—ã —Å —ç–∫–∑–∞–º–µ–Ω–∞–º–∏", 
        "social": "–£ –º–µ–Ω—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞—Ö–∏ –∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ–±—â–µ–Ω–∏–µ–º",
        "family": "–£ –º–µ–Ω—è –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ–º—å–µ–π –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ–º",
        "household": "–£ –º–µ–Ω—è –±—ã—Ç–æ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –≤–æ–ø—Ä–æ—Å—ã –∑–¥–æ—Ä–æ–≤—å—è",
        "career": "–£ –º–µ–Ω—è –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –≤—ã–±–æ—Ä—É –∫–∞—Ä—å–µ—Ä—ã"
    }
    
    category_names = {
        "finance": "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã",
        "study": "–£—á–µ–±–Ω—ã–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏",
        "social": "–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞—Ö–∏", 
        "family": "–°–µ–º—å—è –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ",
        "household": "–ë—ã—Ç–æ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã",
        "career": "–ü—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è"
    }
    
    if category in category_messages:
        bot.edit_message_text(
            f"–í—ã –≤—ã–±—Ä–∞–ª–∏: {category_names[category]}\n\n–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –≤–∞—à –∑–∞–ø—Ä–æ—Å...",
            call.message.chat.id,
            call.message.message_id
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ shai.pro
        send_to_shai_pro(category_messages[category], call.from_user, call.message.chat, category)

def send_to_shai_pro(text, user, chat, category=None):
    headers = {
        'Authorization': 'Bearer app-LqQKmr2WcmFUTAjZk2adM46j',
        'Content-Type': 'application/json'
    }
    
    data = {
        'inputs': {},
        'query': text,
        'response_mode': 'blocking',
        'user': str(user.id)
    }
    
    try:
        response = requests.post('https://hackathon.shai.pro/v1/chat-messages', 
                               json=data, headers=headers, timeout=30)
        
        if response.status_code == 200:
            result = response.json()
            answer = result.get('answer', '')
            
            if not answer or answer.strip() == '':
                answer = "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —Å–º–æ–≥ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å."
            
            if len(answer) > 4096:
                answer = answer[:4090] + "..."
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∏–∞–ª–æ–≥ –≤ –ë–î
            save_conversation(user.id, text, answer, category)
            
            # –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –º–µ–Ω—é
            student = get_student_by_id(user.id)
            language = student.get('user_language', 'ru') if student else 'ru'
            markup = types.InlineKeyboardMarkup()
            markup.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é", callback_data="back_to_menu"))
            
            bot.send_message(chat.id, answer, reply_markup=markup)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç –≤ –∞–¥–º–∏–Ω—Å–∫—É—é –≥—Ä—É–ø–ø—É
            send_conversation_report(user, text, answer, category)
            
        else:
            bot.send_message(chat.id, f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞. –ö–æ–¥: {response.status_code}")
            
    except requests.Timeout:
        bot.send_message(chat.id, "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: {e}")
        bot.send_message(chat.id, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

def send_conversation_report(user, question, answer, category):
    try:
        student = get_student_by_id(user.id)
        if not student:
            return
            
        category_names = {
            'finance': 'üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã',
            'study': 'üìö –£—á–µ–±–Ω—ã–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏',
            'social': 'üò∞ –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞—Ö–∏',
            'family': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –°–µ–º—å—è –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ',
            'household': 'üè† –ë—ã—Ç–æ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã',
            'career': 'üéØ –ü—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è'
        }
        
        name = f"{student.get('telegram_first_name', '')} {student.get('telegram_last_name', '')}".strip()
        username = f"@{student.get('telegram_username')}" if student.get('telegram_username') else ""
        
        report = f"""
üí¨ –ù–û–í–´–ô –î–ò–ê–õ–û–ì

üë§ –û—Ç: {name or '–ë–µ–∑ –∏–º–µ–Ω–∏'} {username}
üÜî ID: {user.id}
üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category_names.get(category, '–û–±—â–∏–π –≤–æ–ø—Ä–æ—Å')}
üïê –í—Ä–µ–º—è: {datetime.now().strftime("%d.%m.%Y %H:%M")}

‚ùì –í–æ–ø—Ä–æ—Å:
{question}

ü§ñ –û—Ç–≤–µ—Ç:
{answer[:300]}{'...' if len(answer) > 300 else ''}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
"""
        
        bot.send_message(ADMIN_GROUP_ID, report)
        
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–∞: {e}")

@bot.message_handler(func=lambda message: True)
def handle_message(message):
    user_id = message.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    if user_id in ADMIN_IDS and user_id in admin_states:
        handle_admin_message(message)
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–Ω–∫–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    if user_id in user_states:
        state = user_states[user_id]
        student = get_student_by_id(user_id)
        language = student.get('user_language', 'ru') if student else 'ru'
        
        if state == UserState.AGE:
            try:
                age = int(message.text)
                if 16 <= age <= 35:
                    profile_data = student.copy()
                    profile_data['user_age'] = age
                    save_student_profile(profile_data)
                    
                    user_states[user_id] = UserState.GENDER
                    markup = create_gender_menu(language)
                    bot.reply_to(message, get_text(language, 'gender_request'), reply_markup=markup)
                else:
                    bot.reply_to(message, get_text(language, 'age_invalid'))
            except ValueError:
                bot.reply_to(message, get_text(language, 'age_invalid'))
                
        elif state == UserState.SPECIALTY:
            profile_data = student.copy()
            profile_data['user_specialty'] = message.text
            save_student_profile(profile_data)
            
            user_states[user_id] = UserState.HOUSING
            markup = create_housing_menu(language)
            bot.reply_to(message, get_text(language, 'housing_request'), reply_markup=markup)
    
    else:
        # –û–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        student = get_student_by_id(user_id)
        if student and student.get('profile_completed'):
            send_to_shai_pro(message.text, message.from_user, message.chat)
        else:
            start_command(message)

def handle_admin_message(message):
    admin_id = message.from_user.id
    state = admin_states.get(admin_id, AdminState.IDLE)
    
    if state == AdminState.SELECTING_USER:
        try:
            target_user_id = int(message.text)
            student = get_student_by_id(target_user_id)
            
            if student:
                admin_states[admin_id] = AdminState.WRITING_MESSAGE
                # –í—Ä–µ–º–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º ID —Ü–µ–ª–µ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if 'temp_data' not in globals():
                    globals()['temp_data'] = {}
                globals()['temp_data'][admin_id] = {'target_user_id': target_user_id}
                
                name = f"{student.get('telegram_first_name', '')} {student.get('telegram_last_name', '')}".strip()
                bot.reply_to(message, f"–ù–∞–π–¥–µ–Ω —Å—Ç—É–¥–µ–Ω—Ç: {name or '–ë–µ–∑ –∏–º–µ–Ω–∏'}\n\n–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:")
            else:
                bot.reply_to(message, "–°—Ç—É–¥–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:")
        except ValueError:
            bot.reply_to(message, "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID. –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π ID:")
    
    elif state == AdminState.WRITING_MESSAGE:
        if 'temp_data' in globals() and admin_id in globals()['temp_data']:
            target_user_id = globals()['temp_data'][admin_id]['target_user_id']
            message_text = message.text
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ë–î
            save_admin_message(admin_id, target_user_id, message_text)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç—É
            try:
                bot.send_message(target_user_id, f"üìß –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏:\n\n{message_text}")
                bot.reply_to(message, "‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!")
            except Exception as e:
                bot.reply_to(message, f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")
            
            # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            admin_states[admin_id] = AdminState.IDLE
            del globals()['temp_data'][admin_id]
        
    elif state == AdminState.SEARCHING:
        search_term = message.text
        students = get_all_students(limit=10, search_term=search_term)
        
        if students:
            text = f"üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–æ '{search_term}':\n\n"
            
            for i, student in enumerate(students, 1):
                name = f"{student.get('telegram_first_name', '')} {student.get('telegram_last_name', '')}".strip()
                username = f"@{student.get('telegram_username')}" if student.get('telegram_username') else ""
                
                text += f"{i}. {name or '–ë–µ–∑ –∏–º–µ–Ω–∏'} {username}\n"
                text += f"   ID: {student['telegram_id']}\n"
                text += f"   –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å: {student.get('user_specialty', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n\n"
            
            bot.reply_to(message, text)
        else:
            bot.reply_to(message, "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
        
        admin_states[admin_id] = AdminState.IDLE

def send_profile_to_admin(profile):
    try:
        region_names = {
            'astana': '–ì–æ—Ä–æ–¥ –ê—Å—Ç–∞–Ω–∞', 'almaty': '–ì–æ—Ä–æ–¥ –ê–ª–º–∞-–ê—Ç–∞', 'shymkent': '–ì–æ—Ä–æ–¥ –®—ã–º–∫–µ–Ω—Ç',
            'abai': '–ê–±–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', 'akmola': '–ê–∫–º–æ–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', 'aktobe': '–ê–∫—Ç—é–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            'almaty_region': '–ê–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', 'atyrau': '–ê—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', 'east_kz': '–í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            'zhambyl': '–ñ–∞–º–±—ã–ª—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', 'jetysu': '–ñ–µ—Ç—ã—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', 'west_kz': '–ó–∞–ø–∞–¥–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            'karaganda': '–ö–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', 'kostanay': '–ö–æ—Å—Ç–∞–Ω–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', 'kyzylorda': '–ö—ã–∑—ã–ª–æ—Ä–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            'mangistau': '–ú–∞–Ω–≥–∏—Å—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', 'pavlodar': '–ü–∞–≤–ª–æ–¥–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', 'north_kz': '–°–µ–≤–µ—Ä–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            'turkestan': '–¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', 'ulytau': '–£–ª—ã—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å'
        }
        
        family_names = {'full': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –ü–æ–ª–Ω–∞—è —Å–µ–º—å—è', 'incomplete': 'üíî –ù–µ–ø–æ–ª–Ω–∞—è —Å–µ–º—å—è', 'orphan': 'üòî –°–∏—Ä–æ—Ç–∞'}
        gender_names = {'male': 'üë® –ú—É–∂—Å–∫–æ–π', 'female': 'üë© –ñ–µ–Ω—Å–∫–∏–π'}
        housing_names = {'dormitory': 'üè† –û–±—â–µ–∂–∏—Ç–∏–µ', 'rent': 'üè° –ê—Ä–µ–Ω–¥–∞ –∂–∏–ª—å—è', 'own': 'üèòÔ∏è –°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –∂–∏–ª—å–µ'}
        
        name = f"{profile.get('telegram_first_name', '')} {profile.get('telegram_last_name', '')}".strip()
        
        report = f"""
üìã –ù–û–í–´–ô –°–¢–£–î–ï–ù–¢ –ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–ù

üÜî Telegram ID: {profile.get('telegram_id')}
üìû Username: @{profile.get('telegram_username', '–Ω–µ —É–∫–∞–∑–∞–Ω')}
üë§ –ò–º—è: {name or '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
üéÇ –í–æ–∑—Ä–∞—Å—Ç: {profile.get('user_age')}
‚ößÔ∏è –ü–æ–ª: {gender_names.get(profile.get('user_gender'), '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}
üèôÔ∏è –ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è: {region_names.get(profile.get('user_birthplace'), '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}
üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –°–µ–º—å—è: {family_names.get(profile.get('user_family_status'), '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}
üìö –ö—É—Ä—Å: {profile.get('user_course')} –∫—É—Ä—Å
üéì –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å: {profile.get('user_specialty')}
üè† –ñ–∏–ª—å–µ: {housing_names.get(profile.get('user_housing_type'), '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}
üåê –Ø–∑—ã–∫: {profile.get('user_language', 'ru').upper()}
üïê –í—Ä–µ–º—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {datetime.now().strftime("%d.%m.%Y %H:%M")}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
"""
        
        bot.send_message(ADMIN_GROUP_ID, report)
        
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è –∞–¥–º–∏–Ω–∞–º: {e}")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
init_database()

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
if __name__ == "__main__":
    logging.info("Bot started")
    bot.polling()